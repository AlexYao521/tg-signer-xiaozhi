# 冷却法则明示文档

本文档详细说明修仙机器人各项功能的冷却时间规则。

## 1. 每日任务（Daily Tasks）

每日任务在每日凌晨自动重置，可重新执行。

| 任务名称 | 指令 | 冷却时间 | 说明 |
|---------|------|---------|------|
| 宗门点卯 | `.宗门点卯` | 24小时 | 每日一次，过凌晨自动重置 |
| 宗门传功 | `.宗门传功` | 24小时 | 每日最多3次，过凌晨自动重置 |
| 每日问安 | `.每日问安` | 24小时 | 每日一次，过凌晨自动重置 |

**重置时间：** 每日凌晨00:00（系统时间）

## 2. 周期任务（Periodic Tasks）

周期任务在执行后进入冷却，冷却结束后可再次执行。

| 任务名称 | 指令 | 冷却时间 | 说明 |
|---------|------|---------|------|
| 闭关修炼 | `.闭关修炼` | 16分钟（兜底） | 实际冷却时间从响应文本解析 |
| 引道 | `.引道 水` | 12小时 | 固定冷却12小时 |
| 启阵 | `.启阵` | 12小时 | 固定冷却12小时 |
| 探寻裂缝 | `.探寻裂缝` | 12小时 | 固定冷却12小时，失败也进入冷却 |
| 问道 | `.问道` | 12小时 | 固定冷却12小时 |
| 元婴出窍 | `.元婴出窍` | 8小时 | 固定冷却8小时 |

**冷却解析逻辑：**
- 优先从响应文本中解析实际冷却时间
- 支持格式："X小时Y分钟Z秒"、"Y分钟Z秒"、"Z秒"
- 如果解析失败或结果异常（小于10分钟），使用默认冷却时间

**预热策略：**
- 探寻裂缝：如果遭遇风暴或受创，在冷却结束前5-10分钟安排预热探测

## 3. 星宫（Star Palace）

### 3.1 星宫操作优先级

**核心设计：永远先执行 `.安抚星辰`，再执行 `.观星台`**

操作序列：
1. `.安抚星辰` （优先级P0）
2. `.观星台` （优先级P1，3-6秒后）
3. 根据观星台状态执行后续操作

### 3.2 星辰牵引冷却时间

不同星辰的牵引凝聚时间不同：

| 星辰名称 | 冷却时间 | 说明 |
|---------|---------|------|
| 赤血星 | 4小时 | 四时辰 |
| 庚金星 | 6小时 | 六时辰 |
| 建木星 | 8小时 | 八时辰 |
| 天雷星 | 24小时 | 二十四时辰（一天） |
| 帝魂星 | 48小时 | 四十八时辰（两天） |

**牵引流程：**
1. 观星台检测到空闲引星盘
2. 按配置的星辰序列轮转牵引
3. 牵引成功后进入凝聚状态
4. 凝聚完成后可收集精华

### 3.3 观星台状态与响应

| 状态 | 说明 | 下一步操作 | 优先级 |
|-----|------|-----------|-------|
| 精华已成 | 星辰凝聚完成 | `.收集精华` | P0 |
| 空闲 | 引星盘无星辰 | `.牵引星辰 <编号> <星名>` | P1 |
| 凝聚中 | 星辰正在凝聚 | 等待（记录成熟时间） | P2 |
| 星光黯淡/元磁紊乱 | 星辰状态异常 | `.安抚星辰` | P0 |

## 4. 小药园（Herb Garden）

### 4.1 灵树灌溉

| 任务名称 | 指令 | 冷却时间 |
|---------|------|---------|
| 灵树灌溉 | `.灵树灌溉` | 1小时 |

### 4.2 种子成熟时间

不同种子的成熟时间：

| 种子名称 | 成熟时间 | 说明 |
|---------|---------|------|
| 凝血草种子 | 4小时 | 基础药材 |
| 清灵草种子 | 8小时 | 高级药材 |

### 4.3 药园操作流程

1. **维护操作**（优先级P0）
   - `.除虫` - 清除害虫侵扰
   - `.除草` - 清除杂草横生
   - `.浇水` - 补充灵气干涸

2. **采药操作**（优先级P1）
   - `.采药` - 一键采集所有成熟药材

3. **播种操作**（优先级P1）
   - `.播种 <地块> <种子>` - 在空闲地块播种

**操作顺序：** 维护 → 采药 → 播种

## 5. 冷却解析器

### 5.1 支持的时间格式

冷却解析器支持以下格式：

- `12小时30分钟` → 45000秒
- `3分钟20秒` → 200秒
- `45秒` → 45秒
- `2小时` → 7200秒
- `30分钟` → 1800秒

### 5.2 容错处理

- 支持全角和半角字符
- 支持多余空格
- 自动去除无关字符
- 支持"小时"、"时"、"分钟"、"分"、"秒"等变体

### 5.3 异常处理

- 解析结果小于10分钟且默认冷却大于1小时时，使用默认值
- 无法解析时，使用配置的默认冷却时间
- 所有解析错误会记录WARNING日志

### 5.4 使用示例

```python
from tg_signer.cooldown_parser import extract_cooldown_with_fallback

# 从响应文本中提取冷却时间
text = "请在 12小时30分钟 后再来"
cooldown = extract_cooldown_with_fallback(text, "问道")
# cooldown = 45000 秒

# 如果解析失败，会自动使用默认值
text = "冷却中"
cooldown = extract_cooldown_with_fallback(text, "问道")
# cooldown = 43200 秒（12小时）
```

## 6. 配置冷却时间

### 6.1 修改默认冷却时间

编辑 `tg_signer/cooldown_config.py` 文件：

```python
PERIODIC_COOLDOWNS = {
    "闭关修炼": 16 * 60,  # 16分钟
    "引道": 12 * 3600,    # 12小时
    # ... 其他配置
}
```

### 6.2 修改星辰牵引时间

```python
STAR_PULL_COOLDOWNS = {
    "赤血星": 4 * 3600,   # 4小时
    "庚金星": 6 * 3600,   # 6小时
    # ... 其他配置
}
```

### 6.3 修改种子成熟时间

```python
SEED_MATURITY_HOURS = {
    "凝血草种子": 4,  # 4小时
    "清灵草种子": 8,  # 8小时
}
```

## 7. 最佳实践

### 7.1 冷却管理

1. **避免频繁操作**：尊重冷却时间，避免触发慢速模式
2. **合理安排序列**：在配置中设置合理的星辰牵引序列
3. **监控日志**：关注冷却解析的WARNING日志，及时调整配置

### 7.2 异常处理

1. **网络波动**：冷却解析失败会自动使用默认值
2. **文本变更**：游戏文本更新后，检查解析器是否需要更新
3. **状态同步**：定期备份状态文件，防止数据丢失

### 7.3 性能优化

1. **批量操作**：药园维护使用一键操作（除虫、除草、浇水）
2. **智能调度**：根据成熟时间提前安排扫描，避免延迟
3. **优先级管理**：高价值操作（收集精华、采药）使用P0优先级

## 8. 故障排查

### 8.1 冷却时间不准确

**症状：** 任务过早或过晚执行

**排查步骤：**
1. 检查日志中的冷却解析记录
2. 确认响应文本格式是否变更
3. 手动测试解析器：`_extract_cooldown_seconds(text, command)`

**解决方案：**
- 更新正则表达式以匹配新格式
- 调整默认冷却时间
- 增加容错规则

### 8.2 星宫操作失败

**症状：** 安抚失败或观星台无响应

**排查步骤：**
1. 确认是否先执行了安抚星辰
2. 检查安抚和观星台的时间间隔
3. 查看日志中的状态解析记录

**解决方案：**
- 确保安抚优先级为P0
- 增加安抚后的等待时间（3-6秒）
- 检查去重键是否正确

### 8.3 药园播种失败

**症状：** 种子不足或播种未成功

**排查步骤：**
1. 检查种子库存状态
2. 确认地块是否为空闲状态
3. 查看播种响应文本

**解决方案：**
- 在播种前执行兑换操作
- 确保维护操作在采药前完成
- 增加操作间隔时间

## 9. 更新日志

| 版本 | 日期 | 更新内容 |
|-----|------|---------|
| 1.0 | 2024-01-XX | 初始版本，定义所有冷却规则 |

## 10. 相关文档

- [ARCHITECTURE.md](./ARCHITECTURE.md) - 系统架构设计
- [活动回复词.md](./活动回复词.md) - 活动响应规则
- [README.md](./README.md) - 项目说明
